<header class="header" x-data="searchComponent()">
  <div class="nav-container">
    <a class="logo-link" href="{{ "/" | relLangURL }}">
      <span class="site-title">{{ .Site.Title }}</span>
      <span class="header-hidden">Navigate back to the homepage</span>
    </a>
    <div class="nav-controls{{ if eq site.Language.Lang "ar" }} rtl{{ end }}">
      {{- if .IsTranslated }}
      <div class="language-selector" id="langSelector">
        <button 
          class="lang-button" 
          onclick="toggleLangMenu()"
          aria-label="Select language"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
          </svg>
          <span>{{ .Site.Language.LanguageName }}</span>
          <svg class="lang-chevron" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <div class="lang-menu" id="langMenu">
          {{- range .AllTranslations }}
          <a 
            href="{{ .Permalink }}" 
            class="lang-option{{ if eq $.Site.Language .Language }} active{{ end }}"
          >
            {{ .Language.LanguageName }}
          </a>
          {{- end }}
        </div>
      </div>
      {{- end }}

      <div class="search-container" :class="{ 'search-active': isSearchOpen }">
        <button
          @click="toggleSearch()"
          class="search-toggle icon-wrapper"
          aria-label="Toggle search"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </div>

      <!-- Centered Search Overlay -->
      <div x-show="isSearchOpen" x-cloak class="search-overlay" @click.self="closeSearch()" :class="{ 'search-rtl': isRtl }">
        <div class="search-overlay-content">
          <div class="search-center-input">
            <svg class="search-center-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input
              type="text"
              x-model="query"
              @input.debounce.300ms="search()"
              @keydown.escape="closeSearch()"
              placeholder="{{ i18n "search_placeholder" }}"
              class="search-center-field"
              ref="searchInput"
            >
          </div>
          <div class="search-center-results">
            <div x-show="isLoading" class="search-center-loading">
              <span class="search-loading-spinner"></span>
              <div>{{ i18n "searching" }}</div>
            </div>
            <div x-show="results.length > 0 && !isLoading" class="search-center-results-list">
              <template x-for="result in results" :key="result.permalink">
                <a :href="result.permalink" class="search-center-result-item" @click="closeSearch()">
                  <span class="search-center-result-title" x-text="result.title"></span>
                  <span class="search-center-result-summary" x-text="result.summary"></span>
                </a>
              </template>
            </div>
            <div x-show="query.length > 0 && results.length === 0 && !isLoading" class="search-center-no-results">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                <line x1="8" y1="8" x2="14" y2="14"></line>
                <line x1="14" y1="8" x2="8" y2="14"></line>
              </svg>
              <div>{{ i18n "no_results" }}</div>
            </div>
          </div>
        </div>
      </div>

      <button id="copyButton" class="icon-wrapper">
        {{ partial "icons/ui/link.html" . }}
        <div id="toolTip" class="tool-tip">
            copied
        </div>
        <input id="copyText" style="opacity: 0;" type="text" class="tool-tip" />
      </button>

      <button id="themeColorButton" class="icon-wrapper">
        <div id="sunRays" class="sun-rays"></div>
        <div id="moonOrSun" class="moon-or-sun"></div>
        <div id="moonMask" class="moon-mask"></div>
      </button>
    </div>
  </div>

  <script>
    function toggleLangMenu() {
      const menu = document.getElementById('langMenu');
      const btn = document.querySelector('#langSelector .lang-button');
      menu.classList.toggle('open');
      btn.classList.toggle('active');
    }

    document.addEventListener('click', function(e) {
      const selector = document.getElementById('langSelector');
      const menu = document.getElementById('langMenu');
      const btn = selector.querySelector('.lang-button');
      if (selector && !selector.contains(e.target)) {
        menu.classList.remove('open');
        btn.classList.remove('active');
      }
    });

    function searchComponent() {
      return {
        isSearchOpen: false,
        query: '',
        results: [],
        isLoading: false,
        fuse: null,
        isRtl: {{ if eq site.Language.Lang "ar" }}true{{ else }}false{{ end }},

        init() {
          this.$watch('isSearchOpen', (value) => {
            if (value) {
              this.$nextTick(() => {
                this.$refs.searchInput.focus();
              });
            }
          });
        },

        toggleSearch() {
          this.isSearchOpen = !this.isSearchOpen;
          if (this.isSearchOpen && !this.fuse) {
            this.loadIndex();
          }
        },

        closeSearch() {
          this.isSearchOpen = false;
          this.query = '';
          this.results = [];
        },

        async loadIndex() {
          this.isLoading = true;
          try {
            const response = await fetch(window.searchIndexURL);
            const data = await response.json();
            this.fuse = new Fuse(data, {
              keys: ['title', 'summary'],
              threshold: 0.3,
              includeMatches: true
            });
          } catch (e) {
            console.error('Failed to load search index:', e);
          }
          this.isLoading = false;
        },

        search() {
          if (!this.query || !this.fuse) {
            this.results = [];
            return;
          }
          const searchResults = this.fuse.search(this.query);
          this.results = searchResults.map(r => r.item).slice(0, 10);
        }
      };
    }
  </script>

    <style>
    .search-container {
      position: relative; 
    }
    [dir="rtl"] .search-container {
    }
    .logo-link {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
    }
    .site-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }
    @media (max-width: 540px) {
      .site-title { 
        font-size: 16px; 
      }
    }
    .nav-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-controls.rtl {
      direction: rtl;
    }
    @media (max-width: 768px) {
      .nav-controls {
        gap: 4px;
      }
    }

    /* Tablet */
    @media (max-width: 735px) {
      .nav-container {
        padding: 50px 2rem 0;
      }
    }

    /* Mobile */
    @media (max-width: 540px) {
      .nav-container {
        padding: 30px 1rem 0;
      }
    }
    .search-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s ease, transform 0.2s ease;
      color: var(--primary);
    }
    .search-toggle:hover {
      background-color: var(--hover);
      transform: scale(1.1);
    }
    .lang-button {
      display: flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: none;
      color: var(--primary);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.7;
    }
    .lang-button:hover,
    .lang-button.active {
      background: var(--hover);
      opacity: 1;
    }
    .lang-button svg {
      color: var(--primary);
    }
    .lang-chevron {
      transition: transform 0.2s ease;
    }
    .lang-button.active .lang-chevron {
      transform: rotate(180deg);
    }
    [dir="rtl"] .lang-button.active .lang-chevron {
      transform: rotate(180deg) scaleX(-1);
    }
    .language-selector {
      position: relative;
    }
    [dir="rtl"] .language-selector {
    }
    .lang-menu {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--horizontalRule);
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      min-width: 120px;
      z-index: 1000;
      padding: 4px 0;
      display: none;
    }
    .lang-menu.open {
      display: block;
    }
    [dir="rtl"] .lang-menu {
      left: auto;
      right: 50%;
      transform: translateX(50%);
    }
    [dir="rtl"] .lang-menu.open {
      transform: translateX(50%);
    }
    .lang-option {
      display: block;
      padding: 10px 16px;
      color: var(--primary);
      text-decoration: none;
      font-size: 13px;
      text-align: center;
      transition: background 0.15s ease;
    }
    .lang-option:hover {
      background: var(--hover);
    }
    .lang-option.active {
      color: var(--accent);
      font-weight: 600;
      background: var(--hover);
    }

    /* Mobile Styles */
    @media (max-width: 540px) {
      .nav-container {
        padding: 25px 0.75rem 0;
      }
      .logo-link {
        flex: 1;
        min-width: 0;
      }
      .site-title {
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .nav-controls {
        gap: 0;
        flex-shrink: 0;
        padding: 0;
      }
      .lang-button,
      .search-toggle,
      .icon-wrapper {
        padding: 3px;
        margin: 0;
      }
      .lang-button svg,
      .search-toggle svg {
        width: 32px;
        height: 32px;
      }
      .lang-button svg {
        width: 22px;
        height: 22px;
      }
      .lang-chevron {
        display: none;
      }
      .icon-wrapper svg {
        width: 22px;
        height: 22px;
      }
      .lang-menu {
        right: -10px;
        left: auto;
        transform: none;
        min-width: 90px;
      }
      .lang-menu.open {
        transform: none;
      }
      .lang-option {
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    /* Tablet */
    @media (max-width: 735px) {
      .nav-container {
        padding: 40px 1.5rem 0;
      }
      .site-title {
        font-size: 15px;
      }
      .nav-controls {
        gap: 6px;
      }
    }

    .search-toggle svg {
      transition: transform 0.3s ease;
    }
    .search-active .search-toggle svg {
      transform: scale(1.15);
    }
    /* Centered Search Overlay */
    .search-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 9999;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 12vh;
      animation: searchOverlayFadeIn 0.3s ease-out;
    }
    @keyframes searchOverlayFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    .search-overlay.search-rtl {
      direction: rtl;
    }
    .search-overlay-content {
      width: 100%;
      max-width: 680px;
      margin: 0 20px;
      animation: searchSlideDown 0.3s ease-out;
    }
    @keyframes searchSlideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .search-center-input {
      display: flex;
      align-items: center;
      background: var(--card);
      border: 2px solid var(--horizontalRule);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      margin-bottom: 20px;
    }
    .search-center-input:focus-within {
      border-color: var(--accent);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    }
    .search-center-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      margin-right: 16px;
      color: var(--primary);
      opacity: 0.6;
    }
    .search-center-field {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--primary);
      font-size: 18px;
      outline: none;
      padding: 0;
    }
    .search-center-field::placeholder {
      color: var(--primary);
      opacity: 0.5;
    }
    .search-center-results {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      max-height: 50vh;
      overflow-y: auto;
      border: 1px solid var(--horizontalRule);
    }
    .search-center-results::-webkit-scrollbar {
      width: 6px;
    }
    .search-center-results::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 0 16px 16px 0;
    }
    .search-center-results::-webkit-scrollbar-thumb {
      background: var(--horizontalRule);
      border-radius: 3px;
    }
    .search-center-results::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
      opacity: 0.5;
    }
    .search-center-loading,
    .search-center-no-results {
      padding: 48px 24px;
      text-align: center;
      color: var(--primary);
      opacity: 0.7;
    }
    .search-center-no-results svg {
      margin-bottom: 16px;
      opacity: 0.5;
      color: var(--primary);
    }
    .search-center-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .search-loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid var(--horizontalRule);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: searchSpin 0.8s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes searchSpin {
      to { transform: rotate(360deg); }
    }
    .search-center-results-list {
      padding: 8px 0;
    }
    .search-center-result-item {
      display: block;
      padding: 16px 24px;
      text-decoration: none;
      border-bottom: 1px solid var(--horizontalRule);
      transition: background 0.2s ease, padding-left 0.2s ease;
    }
    .search-center-result-item:last-child {
      border-bottom: none;
    }
    .search-center-result-item:hover {
      background: var(--hover);
      padding-left: 28px;
    }
    .search-center-result-item:active {
      background: var(--inputBackground);
    }
    .search-center-result-title {
      display: block;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 6px;
      font-size: 16px;
      line-height: 1.4;
    }
    .search-center-result-summary {
      display: block;
      font-size: 14px;
      color: var(--primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      opacity: 0.7;
    }
  </style>
</header>
